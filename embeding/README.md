# 흉부 X-ray 이미지 임베딩 및 벡터 검색 파이프라인

이 프로젝트는 흉부 X-ray 이미지와 관련 메타데이터를 [BioViL-T](https://www.google.com/search?q=https://github.com/microsoft/BioViL-T) 모델을 사용하여 임베딩하고, 이를 [Pinecone](https://www.pinecone.io/) 벡터 데이터베이스에 저장하여 유사 이미지 검색을 가능하게 하는 완전한 파이프라인을 제공합니다.

## ✨ 주요 기능

  - **데이터 전처리**: CSV 파일에 명시된 이미지와 바운딩 박스(Bbox) 정보를 불러와 파이프라인에 적합한 형태로 가공합니다.
  - **이미지 임베딩**: 의료 이미지에 특화된 BioViL-T 모델을 사용하여 각 X-ray 이미지로부터 512차원의 임베딩 벡터를 추출합니다.
  - **메타데이터 생성**: 이미지의 진단명(레이블), 설명, 바운딩 박스 등의 정보를 검색에 활용할 수 있는 메타데이터로 함께 저장합니다.
  - **Pinecone 연동**: 생성된 벡터와 메타데이터를 Pinecone 서버리스 인덱스에 효율적으로 업로드(upsert)합니다.
  - **유사도 검색**: 저장된 벡터를 기반으로 특정 이미지와 시각적으로 가장 유사한 이미지를 검색하는 테스트 기능을 포함합니다.

-----

## 🚀 시작하기

### 1\. 요구사항

스크립트를 실행하기 위해 아래의 라이브러리들이 필요합니다.

```bash
pip install pandas numpy torch tqdm Pillow pinecone-client health-multimodal
```

또한, Pinecone API 키를 환경 변수로 설정해야 합니다.

```bash
export PINECONE_API_KEY="YOUR_PINECONE_API_KEY"
```

### 2\. 설정

스크립트 상단의 사용자 설정 부분을 본인의 환경에 맞게 수정해야 합니다.

```python
# embed_text.py

# 사용자 설정 부분 - 본인 경로에 맞게 수정하세요
CSV_PATH = '/path/to/your/BBox_List_2017.csv'
IMAGE_DIR = '/path/to/your/bbox_images'

# Pinecone 인덱스 이름 설정
INDEX_NAME = "cxr-image-meta-512"
```

### 3\. 실행 방법

터미널에서 아래의 명령어를 입력하여 파이프라인을 실행합니다.

```bash
python embed_image_metadata.py
```

스크립트는 데이터 로딩, 전처리, 임베딩 생성, Pinecone 업로드까지의 모든 과정을 자동으로 수행합니다. 모든 과정이 완료된 후, 샘플 이미지를 사용하여 검색 테스트를 수행할지 묻는 메시지가 나타납니다.

-----

## ⚙️ 코드 설명

이 스크립트는 총 6개의 단계로 구성되어 있습니다.

### 1단계: 설정 및 초기화

  - 스크립트 실행에 필요한 기본 경로, Pinecone API 키, 인덱스 이름, 하드웨어 장치(CPU/GPU) 등을 설정합니다.
  - 각 진단명에 대한 한국어 설명 템플릿(`LABEL_TEMPLATES`)을 정의하여 나중에 메타데이터 생성 시 활용합니다.

### 2단계: 데이터 로드 및 전처리

  - `load_and_preprocess_data()`: `BBox_List_2017.csv` 파일을 `pandas`로 불러와 바운딩 박스 좌표를 계산하고, 불필요한 데이터를 정리합니다.
  - `create_roi_dict()`: 전처리된 데이터를 이미지 파일명 기준으로 그룹화합니다. 하나의 이미지에 여러 진단 정보(ROI)가 있는 경우, 이를 리스트로 묶어 `{이미지 ID: [진단정보1, 진단정보2, ...]}` 형태의 딕셔너리로 만듭니다.

### 3단계: 이미지 임베딩 생성

  - `initialize_models()`: `health-multimodal` 라이브러리에서 사전 훈련된 BioViL-T 이미지 모델과 이미지 전처리(리사이즈, 크롭, 정규화 등)를 위한 변환기(transform)를 로드합니다.
  - `get_image_embedding()`: 이미지 경로를 입력받아 전처리 후 모델에 전달하고, 결과로 나온 512차원 임베딩 벡터를 반환합니다. 파일이 없거나 이미지 처리 중 오류가 발생하면 예외 처리를 수행합니다.

### 4단계: Pinecone 초기화

  - `initialize_pinecone()`: 설정된 API 키를 사용하여 Pinecone에 연결합니다. 지정된 `INDEX_NAME`의 인덱스가 존재하지 않으면 512차원 벡터, 코사인 유사도(cosine similarity) 기준으로 새로운 서버리스 인덱스를 생성합니다. 이미 존재하면 해당 인덱스에 연결합니다.

### 5단계: 메타데이터 생성 및 업로드

  - `create_metadata()`: 이미지 ID와 진단 정보를 바탕으로 Pinecone에 저장할 메타데이터 딕셔너리를 생성합니다. 여기에는 검색 필터링에 유용한 레이블, 설명, 바운딩 박스 좌표 등이 포함됩니다.
  - `process_and_upload_embeddings()`: 전체 파이프라인을 관장하는 메인 함수입니다.
    1.  모든 이미지에 대해 순서대로 임베딩과 메타데이터를 생성합니다.
    2.  네트워크 효율을 위해 `batch_size` (기본 100개)만큼 데이터를 모아 한 번에 Pinecone에 업서트(upsert)합니다.
    3.  모든 처리가 완료되면 성공/실패 건수와 최종적으로 Pinecone 인덱스에 저장된 총 벡터 수를 출력합니다.

### 6단계: 검색 테스트 (선택 사항)

  - `test_search()`: 업로드가 잘 되었는지 검증하기 위한 함수입니다.
  - 특정 이미지를 쿼리로 사용하여 임베딩을 생성한 뒤, Pinecone의 `query` 기능을 통해 가장 유사한 `top_k`개의 이미지를 검색합니다.
  - 결과로 나온 이미지의 ID, 유사도 점수, 그리고 함께 저장된 메타데이터를 출력하여 성능을 직관적으로 확인할 수 있습니다.